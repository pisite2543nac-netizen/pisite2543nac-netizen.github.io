<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychiatry DocHub - Real Download Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS (Compact & Clean) --- */
        :root {
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --bg-light: #f1f5f9;
            --surface: #ffffff;
            --text: #334155;
            --text-light: #64748b;
            --border: #e2e8f0;
            --radius: 8px;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Prompt', sans-serif; }

        body {
            background-color: var(--bg-light);
            color: var(--text);
            display: flex;
            min-height: 100vh;
            font-size: 14px;
        }

        /* Sidebar */
        aside {
            width: 220px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            position: fixed; height: 100vh; z-index: 10;
        }

        .brand {
            padding: 1.5rem 1rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            display: flex; align-items: center; gap: 8px;
            border-bottom: 1px solid var(--border);
        }

        nav ul { list-style: none; padding: 1rem; }
        nav li { margin-bottom: 4px; }

        nav button {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            color: var(--text-light);
            cursor: pointer;
            border-radius: var(--radius);
            font-size: 0.95rem;
            display: flex; align-items: center; gap: 10px;
        }

        nav button:hover { background-color: #f0fdfa; color: var(--primary); }
        nav button.active { background-color: var(--primary); color: white; }

        /* Main Content */
        main { margin-left: 220px; flex: 1; padding: 1.5rem; max-width: 100%; }

        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .admin-badge {
            font-size: 0.8rem; background: #fee2e2; color: #991b1b;
            padding: 2px 8px; border-radius: 4px; display: none;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex; align-items: center; gap: 6px;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        .btn-danger { background: var(--danger); color: white; }

        /* Views */
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Grid Layout */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1rem;
        }

        .file-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            transition: 0.2s;
            position: relative;
        }
        .file-card:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .file-header { display: flex; gap: 10px; margin-bottom: 0.5rem; }
        .file-icon {
            width: 36px; height: 36px;
            background: #f0fdfa; color: var(--primary);
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        
        .file-info h3 {
            font-size: 0.95rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .file-meta { font-size: 0.8rem; color: var(--text-light); }

        .file-actions {
            margin-top: 1rem;
            display: flex; gap: 0.5rem;
            border-top: 1px solid var(--bg-light);
            padding-top: 0.75rem;
        }

        /* Upload Form */
        .upload-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .upload-drop-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            cursor: pointer;
            background: white;
            transition: 0.2s;
        }
        .upload-drop-area:hover { border-color: var(--primary); background: #f0fdfa; }

        .form-row { margin-bottom: 1rem; }
        .form-row label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85rem; }
        .form-control {
            width: 100%; padding: 0.6rem;
            border: 1px solid var(--border); border-radius: var(--radius);
            font-size: 0.9rem;
        }

        /* Search Bar */
        .search-container { display: flex; gap: 0.5rem; margin-bottom: 1rem; }

        /* Login Modal */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: white; padding: 2rem; border-radius: var(--radius);
            width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            aside { display: none; }
            main { margin-left: 0; }
            .upload-wrapper { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-box">
            <h3 style="margin-bottom:1rem; text-align:center;">Admin Login</h3>
            <input type="password" id="admin-pass" class="form-control" placeholder="Password (admin)" style="margin-bottom:1rem;">
            <div style="display:flex; gap:0.5rem;">
                <button class="btn btn-primary" style="flex:1;" onclick="checkAdmin()">ยืนยัน</button>
                <button class="btn btn-outline" style="flex:1;" onclick="closeLogin()">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside>
        <div class="brand">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            PsyDocs
        </div>
        <nav>
            <ul>
                <li><button class="nav-btn active" onclick="switchView('dashboard')">หน้าหลัก</button></li>
                <li><button class="nav-btn" onclick="switchView('repository')">คลังเอกสาร</button></li>
                <li id="upload-nav" class="hidden"><button class="nav-btn" onclick="switchView('upload')">อัปโหลด</button></li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main>
        <header>
            <h2 id="page-title">ภาพรวมระบบ</h2>
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="admin-badge-display" class="admin-badge">ADMIN</span>
                <button id="auth-btn" class="btn btn-outline btn-sm" onclick="openLogin()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    เข้าสู่ระบบผู้ดูแล
                </button>
            </div>
        </header>

        <!-- DASHBOARD -->
        <section id="dashboard" class="view-section active">
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:1rem; margin-bottom:2rem;">
                <div class="file-card">
                    <div class="file-meta">เอกสารทั้งหมด</div>
                    <div style="font-size:1.5rem; font-weight:600; color:var(--primary);" id="total-docs">0</div>
                </div>
                <div class="file-card">
                    <div class="file-meta">ดาวน์โหลดสะสม</div>
                    <div style="font-size:1.5rem; font-weight:600; color:var(--text);" id="total-downloads">0</div>
                </div>
            </div>
            
            <h3 style="margin-bottom:1rem; font-size:1.1rem;">เอกสารที่เพิ่มมาล่าสุด</h3>
            <div id="recent-grid" class="file-grid"></div>
        </section>

        <!-- REPOSITORY -->
        <section id="repository" class="view-section">
            <div class="search-container">
                <input type="text" class="form-control search-input" placeholder="ค้นหาชื่อเอกสาร..." onkeyup="filterDocs(this.value)">
                <select class="form-control" style="width:150px;" onchange="filterDocs(this.value, true)">
                    <option value="all">ทุกหมวดหมู่</option>
                    <option value="แนวปฏิบัติ">แนวปฏิบัติ</option>
                    <option value="เอกสารผู้ป่วย">เอกสารผู้ป่วย</option>
                    <option value="เภสัชกรรม">เภสัชกรรม</option>
                    <option value="ระเบียบ">ระเบียบ</option>
                </select>
            </div>
            <div id="repo-grid" class="file-grid"></div>
        </section>

        <!-- UPLOAD -->
        <section id="upload" class="view-section">
            <div style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.85rem;">
                ⚠️ <strong>คำเตือน:</strong> ระบบนี้บันทึกไฟล์ลงในเบราว์เซอร์โดยตรง (LocalStorage) ดังนั้น <strong>ไฟล์จะต้องมีขนาดไม่เกิน 500KB</strong> เท่านั้น หากไฟล์ใหญ่กว่านั้นจะไม่สามารถอัปโหลดได้ (เบราว์เซอร์จะแจ้งเตือน)
            </div>

            <div class="upload-wrapper">
                <div class="upload-drop-area" id="drop-zone">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" style="margin-bottom:1rem;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <div style="font-weight:500;">คลิกเพื่อเลือกไฟล์</div>
                    <div style="font-size:0.8rem; color:var(--text-light);">PDF, DOCX, TXT (Max 500KB)</div>
                    <input type="file" id="file-input" style="display:none;" onchange="handleFile(this)">
                    <div id="upload-status" style="font-size:0.85rem; color:var(--primary); margin-top:0.5rem; font-weight:bold;"></div>
                </div>

                <div>
                    <div class="form-row">
                        <label>ชื่อเอกสาร *</label>
                        <input type="text" id="doc-title" class="form-control" placeholder="เช่น ข้อมูลยาจิตเวช...">
                    </div>
                    <div class="form-row">
                        <label>หมวดหมู่ *</label>
                        <select id="doc-cat" class="form-control">
                            <option value="แนวปฏิบัติ">แนวปฏิบัติ</option>
                            <option value="เอกสารผู้ป่วย">เอกสารผู้ป่วย</option>
                            <option value="เภสัชกรรม">เภสัชกรรม</option>
                            <option value="ระเบียบ">ระเบียบ</option>
                        </select>
                    </div>
                    <div style="text-align:right;">
                        <button class="btn btn-primary" onclick="submitUpload()">บันทึกและเผยแพร่</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- CONFIG & STATE ---
        const ADMIN_PASS = "admin";
        let userRole = 'guest'; 
        let docs = [];
        let totalDl = 0;
        let selectedFile = null;

        // --- INIT & LOAD DATA ---
        window.onload = function() {
            loadData();
        };

        function loadData() {
            try {
                docs = JSON.parse(localStorage.getItem('psy_docs')) || [];
                totalDl = parseInt(localStorage.getItem('psy_dl')) || 0;
            } catch (e) {
                console.error("Data corrupted, resetting.");
                docs = [];
            }
            
            // ถ้าไม่มีข้อมูลเลยให้โหลดเป็นค่าเริ่มต้น
            if(docs.length === 0) {
                docs = [
                    {id:1, title: "ข้อแนะนำการใช้ยา (Demo)", cat: "เภสัชกรรม", size: "0.5", date: "2023-11-01", dl: 10, content: null},
                    {id:2, title: "ตัวอย่างแบบประเมิน (Demo)", cat: "แนวปฏิบัติ", size: "0.2", date: "2023-11-05", dl: 5, content: null}
                ];
                saveData();
            }
            updateStats();
        }

        // --- AUTH LOGIC ---
        function openLogin() { document.getElementById('login-overlay').style.display = 'flex'; }
        function closeLogin() { document.getElementById('login-overlay').style.display = 'none'; }
        
        function checkAdmin() {
            const pass = document.getElementById('admin-pass').value;
            if(pass === ADMIN_PASS) {
                userRole = 'admin';
                document.getElementById('admin-badge-display').style.display = 'inline-block';
                document.getElementById('upload-nav').classList.remove('hidden');
                document.getElementById('auth-btn').style.display = 'none'; 
                closeLogin();
                alert("เข้าสู่ระบบผู้ดูแลระบบแล้ว");
            } else {
                alert("รหัสผ่านไม่ถูกต้อง");
            }
        }

        function switchView(viewId) {
            if(viewId === 'upload' && userRole !== 'admin') {
                openLogin();
                return;
            }
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.querySelector(`button[onclick="switchView('${viewId}')"]`);
            if(btn) btn.classList.add('active');

            const titles = {'dashboard':'ภาพรวมระบบ', 'repository':'คลังเอกสาร', 'upload':'อัปโหลดเอกสาร'};
            document.getElementById('page-title').innerText = titles[viewId];
        }

        // --- RENDERING ---
        function renderGrid(containerId, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            data.forEach(doc => {
                const delBtn = (userRole === 'admin') 
                    ? `<button class="btn btn-danger btn-sm" onclick="delDoc(${doc.id})">ลบ</button>` 
                    : '';
                
                const card = document.createElement('div');
                card.className = 'file-card';
                card.innerHTML = `
                    <div class="file-header">
                        <div class="file-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                        </div>
                        <div class="file-info">
                            <h3 title="${doc.title}">${doc.title}</h3>
                            <div class="file-meta">${doc.cat} • ${doc.size}MB</div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary btn-sm" style="flex:1;" onclick="dlDoc(${doc.id})">Download</button>
                        ${delBtn}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateStats() {
            document.getElementById('total-docs').innerText = docs.length;
            document.getElementById('total-downloads').innerText = totalDl;
            
            const recent = [...docs].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,3);
            renderGrid('recent-grid', recent);
            renderGrid('repo-grid', docs); 
        }

        function filterDocs(val, isCat=false) {
            const txt = isCat ? val.toLowerCase() : document.getElementById('repo-grid').parentElement.querySelector('.search-input').value.toLowerCase();
            const cat = isCat ? val.toLowerCase() : document.getElementById('repo-grid').parentElement.querySelector('select').value.toLowerCase();

            const filtered = docs.filter(d => {
                const matchTxt = d.title.toLowerCase().includes(txt);
                const matchCat = cat === 'all' || d.cat.includes(cat);
                return matchTxt && matchCat;
            });
            renderGrid('repo-grid', filtered);
        }

        // --- UPLOAD LOGIC (REAL FILE HANDLING) ---
        const dropZone = document.getElementById('drop-zone');
        dropZone.onclick = () => document.getElementById('file-input').click();
        
        function handleFile(input) {
            if(input.files && input.files[0]) {
                const f = input.files[0];
                // จำกัดขนาดไฟล์ 500KB ป้องกัน LocalStorage เต็ม
                const maxSize = 500 * 1024; 
                if(f.size > maxSize) {
                    alert(`ไฟล์ขนาดใหญ่เกินไป (${(f.size/1024).toFixed(0)}KB) ระบบรองรับไฟล์ไม่เกิน 500KB เพื่อเก็บในเบราว์เซอร์`);
                    input.value = '';
                    return;
                }
                
                selectedFile = f;
                document.getElementById('upload-status').innerText = `✅ เลือกแล้ว: ${f.name} (${(f.size/1024).toFixed(1)}KB)`;
            }
        }

        function submitUpload() {
            const title = document.getElementById('doc-title').value;
            const cat = document.getElementById('doc-cat').value;
            if(!title || !selectedFile) return alert("กรุณากรอกชื่อและเลือกไฟล์");

            // แปลงไฟล์เป็น Base64 เพื่อเก็บลง LocalStorage
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Content = e.target.result; // ข้อมูลไฟล์จริง
                
                try {
                    const newDoc = {
                        id: Date.now(),
                        title: title,
                        cat: cat,
                        size: (selectedFile.size / 1024).toFixed(2),
                        date: new Date().toISOString().split('T')[0],
                        dl: 0,
                        content: base64Content // บันทึกข้อมูลไฟล์จริงไว้ตรงนี้
                    };
                    
                    docs.unshift(newDoc);
                    saveData(); // บันทึก
                    
                    // Reset UI
                    document.getElementById('doc-title').value = '';
                    document.getElementById('upload-status').innerText = '';
                    selectedFile = null;
                    document.getElementById('file-input').value = ''; // Clear file input
                    
                    alert("อัปโหลดสำเร็จ!");
                    switchView('repository');
                } catch (err) {
                    alert("ไม่สามารถบันทึกได้: เบราว์เซอร์เต็ม (Quota Exceeded)");
                }
            };
            reader.readAsDataURL(selectedFile);
        }

        // --- DOWNLOAD LOGIC (REAL) ---
        function dlDoc(id) {
            const doc = docs.find(x => x.id === id);
            if(doc) {
                doc.dl++;
                totalDl++;
                saveData(); // Update Count

                // สร้าง Link เพื่อดาวน์โหลด
                if(doc.content) {
                    const link = document.createElement('a');
                    link.href = doc.content; // ใช้ข้อมูล Base64 ที่เก็บไว้
                    link.download = doc.title; // ตั้งชื่อไฟล์เวลาดาวน์โหลด
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    // กรณีเป็นข้อมูลจำลองเก่า (ไม่มี content)
                    alert("ไฟล์นี้เป็นข้อมูลตัวอย่าง ไม่มีไฟล์จริง กรุณาลบแล้วอัปโหลดใหม่");
                }
            }
        }

        function delDoc(id) {
            if(confirm("ลบไฟล์นี้?")) {
                docs = docs.filter(x => x.id !== id);
                saveData();
            }
        }

        function saveData() {
            try {
                localStorage.setItem('psy_docs', JSON.stringify(docs));
                localStorage.setItem('psy_dl', totalDl);
                updateStats();
            } catch (e) {
                alert("พื้นที่จัดเก็บเต็ม! ลบไฟล์เก่าบางส่วนออก");
            }
        }
    </script>
</body>
</html>
